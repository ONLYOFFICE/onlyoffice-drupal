<?php

/**
 * @file
 * Primary module hooks for ONLYOFFICE Connector module.
 */

/**
 * Copyright (c) Ascensio System SIA 2023.
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation; either version 2
 * of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc.,
 * 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */

use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\onlyoffice\OnlyofficeAppConfig;
use Drupal\onlyoffice\OnlyofficeDocumentHelper;
use Drupal\onlyoffice\OnlyofficeUrlHelper;

/**
 * Implements hook_help().
 */
function onlyoffice_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    case 'help.page.onlyoffice':
      $output = '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('The ONLYOFFICE connector allows users to edit office documents, spreadsheets, and presentations in the Media module from Drupal using ONLYOFFICE Docs packaged as Document Server. Users are able to collaborate on documents in real-time and preview files on public pages.') . '</p>';

      $output .= '<h3>' . t('Installation and configuration') . '</h3>';
      $output .= '<p>' . t('Explore how to install and configure the ONLYOFFICE module for Drupal on the <a href=":onlyoffice-drupal">official project page</a>.', [':onlyoffice-drupal' => 'https://github.com/ONLYOFFICE/onlyoffice-drupal']) . '</p>';

      return $output;
  }
}

/**
 * Implements hook_theme().
 */
function onlyoffice_theme($existing, $type, $theme, $path) {
  return [
    'onlyoffice_editor' => [
      'variables' => [
        'filename' => 'noname',
        'favicon_path' => 'none',
        'doc_server_url' => 'http://127.0.0.1/',
        'config' => '{}',
        'error' => NULL,
      ],
    ],
  ];
}

/**
 * Implements hook_entity_operation().
 */
function onlyoffice_entity_operation(EntityInterface $entity) {
  // Wrap everything in a try/catch to prevent any errors from breaking the page.
  try {
    // First, make sure this is a media entity.
    if ($entity->getEntityTypeId() !== 'media') {
      return [];
    }

    // Check if the entity is valid.
    if (!method_exists($entity, 'getSource')) {
      return [];
    }

    // Reload the entity to ensure it's fully loaded.
    try {
      /** @var \Drupal\media\Entity\Media $media */
      $media = \Drupal::entityTypeManager()
        ->getStorage('media')
        ->load($entity->id());

      if (!$media) {
        return [];
      }
    }
    catch (\Exception $e) {
      \Drupal::logger('onlyoffice')->error('Failed to load media entity: @message', ['@message' => $e->getMessage()]);
      return [];
    }

    // Check if the media entity has a source.
    try {
      $source = $media->getSource();
      if (!$source) {
        return [];
      }

      $pluginId = $source->getPluginId();
      if (!in_array($pluginId, ['file', 'onlyoffice_m_form', 'onlyoffice_pdf_form'])) {
        return [];
      }
    }
    catch (\Exception $e) {
      \Drupal::logger('onlyoffice')->error('Error accessing media source: @message', ['@message' => $e->getMessage()]);
      return [];
    }

    // Check access.
    $account = \Drupal::currentUser()->getAccount();
    if (!$media->access('view', $account)) {
      return [];
    }

    // Get the source field and file.
    try {
      // Get the source field name.
      $source_field_name = OnlyofficeDocumentHelper::getSourceFieldName($media);

      // Check if the field exists and has a value.
      if (!$media->hasField($source_field_name) || $media->get($source_field_name)->isEmpty()) {
        return [];
      }

      // Get the file entity.
      $file = $media->get($source_field_name)->entity;

      // Check if the file entity exists.
      if (!$file) {
        return [];
      }

      $extension = OnlyofficeDocumentHelper::getExtension($file->getFilename());

      if (OnlyofficeDocumentHelper::getDocumentType($extension) === NULL) {
        return [];
      }

      $title = t('View in ONLYOFFICE');

      if ((OnlyofficeDocumentHelper::isEditable($media) || OnlyofficeDocumentHelper::isFillForms($media)) && $media->access('update', $account)) {
        $title = t('Edit in ONLYOFFICE');
      }

      return [
        'onlyoffice' => [
          'title' => $title,
          'weight' => 50,
          'url' => OnlyofficeUrlHelper::getEditorUrl($media),
        ],
      ];
    }
    catch (\Exception $e) {
      \Drupal::logger('onlyoffice')->error('Error in onlyoffice_entity_operation: @message', ['@message' => $e->getMessage()]);
      return [];
    }
  }
  catch (\Throwable $t) {
    // Catch absolutely any error to prevent breaking the page.
    \Drupal::logger('onlyoffice')->error('Unhandled error in onlyoffice_entity_operation: @message', ['@message' => $t->getMessage()]);
    return [];
  }
}

/**
 * Implements hook_library_info_build().
 */
function onlyoffice_library_info_build() {

  $options = \Drupal::config('onlyoffice.settings');

  if ($doc_server_url = $options->get('doc_server_url')) {
    $api_url = $doc_server_url . OnlyofficeAppConfig::getDocServiceApiUrl();
    return [
      'onlyoffice.api' => [
        'js' => [
          $api_url => [],
        ],
      ],
    ];
  }
}
